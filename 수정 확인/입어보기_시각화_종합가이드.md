# 입어보기 버튼 - 모델 실행 시각화 종합 가이드

## 목표
사용자가 "입어보기" 버튼을 클릭했을 때, AI 모델이 실행되는 과정을 직관적으로 이해할 수 있도록 시각적 피드백 제공

---

## 제공되는 3가지 UI 방법

### 방법 1: 전체 화면 로딩 오버레이 (권장) ⭐
**파일**: `VirtualFittingLoader.js`, `VirtualFittingLoader.css`

**특징**:
- 풀스크린 오버레이로 전체 화면 차지
- 단계별 진행 상황 체크리스트
- 진행률 프로그레스 바
- 현재 설정 표시
- 프로페셔널한 느낌

**사용 시기**: 
- 최초 모델 로딩 시 (1-2분 소요)
- 사용자의 주의를 집중시켜야 할 때
- 백그라운드 작업을 차단해야 할 때

**통합 코드**:
```javascript
import VirtualFittingLoader from './VirtualFittingLoader';

// 상태 변수
const [fittingLoading, setFittingLoading] = useState(false);
const [fittingStage, setFittingStage] = useState('initializing');
const [fittingProgress, setFittingProgress] = useState(0);

// JSX
<VirtualFittingLoader
    isLoading={fittingLoading}
    stage={fittingStage}
    progress={fittingProgress}
    showSkeleton={showSkeleton}
    useWarp={useWarp}
/>
```

---

### 방법 2: 인라인 상태 배지
**파일**: `FittingStatusBadge.js`, `FittingStatusBadge.css`

**특징**:
- 비디오 위 작은 배지
- FPS 및 레이턴시 표시
- 방해되지 않는 UI
- 실시간 성능 모니터링

**사용 시기**:
- 이미 로딩이 완료된 후
- 실시간 처리 중임을 알림
- 성능 지표를 보여주고 싶을 때

**통합 코드**:
```javascript
import FittingStatusBadge from './FittingStatusBadge';

// 상태 변수
const [fps, setFps] = useState(0);
const [latency, setLatency] = useState(0);

// JSX (비디오 컨테이너 안에)
<div style={{ position: 'relative' }}>
    <video ref={videoRef} />
    <FittingStatusBadge
        isActive={isFittingMode}
        isProcessing={fittingLoading}
        fps={fps}
        latency={latency}
    />
</div>
```

---

### 방법 3: 버튼 내 인라인 표시 (가장 간단)
**수정 파일**: `main.js`

**특징**:
- 버튼 텍스트와 아이콘 변경
- 추가 컴포넌트 불필요
- 가장 빠른 구현

**통합 코드**:
```javascript
<Button
    variant={isFittingMode ? "danger" : "primary"}
    onClick={handleStartFit}
    disabled={fittingLoading}
>
    {fittingLoading ? (
        <>
            <Spinner
                as="span"
                animation="border"
                size="sm"
                role="status"
                aria-hidden="true"
                className="me-2"
            />
            <span>모델 로딩 중...</span>
        </>
    ) : (
        isFittingMode ? "피팅 중지" : "입어보기"
    )}
</Button>
```

---

## 권장 통합 방식 (방법 1 + 방법 2 조합)

### 1단계: Import

```javascript
// main.js
import React, { useRef, useState, useEffect } from "react";
import { Button, Container, Row, Col, Spinner } from "react-bootstrap";
import { useNavigate } from 'react-router-dom';
import VirtualFittingLoader from './VirtualFittingLoader';
import FittingStatusBadge from './FittingStatusBadge';
```

### 2단계: 상태 변수 추가

```javascript
function Main() {
    // 기존 상태들...
    const [isFittingMode, setIsFittingMode] = useState(false);
    const [showSkeleton, setShowSkeleton] = useState(true);
    const [useWarp, setUseWarp] = useState(true);
    
    // 로딩 관련 상태 추가
    const [fittingLoading, setFittingLoading] = useState(false);
    const [fittingStage, setFittingStage] = useState('initializing');
    const [fittingProgress, setFittingProgress] = useState(0);
    
    // 성능 지표
    const [fps, setFps] = useState(0);
    const [latency, setLatency] = useState(0);
    const lastFrameTimeRef = useRef(Date.now());
    
    // ... 나머지 코드
}
```

### 3단계: startVirtualFitting 수정

```javascript
const startVirtualFitting = async () => {
    console.log("[프론트] 가상 피팅 시작");
    
    // 1. 로딩 시작
    setFittingLoading(true);
    setFittingStage('initializing');
    setFittingProgress(10);
    
    try {
        // 2. 단계별 진행 (시뮬레이션)
        // 실제로는 백엔드 응답을 기다리거나 첫 프레임을 받을 때까지
        
        setFittingStage('loading_pose');
        setFittingProgress(30);
        await new Promise(resolve => setTimeout(resolve, 500));
        
        setFittingStage('loading_cloth');
        setFittingProgress(50);
        await new Promise(resolve => setTimeout(resolve, 500));
        
        setFittingStage('detecting_pose');
        setFittingProgress(70);
        await new Promise(resolve => setTimeout(resolve, 500));
        
        setFittingStage('ready');
        setFittingProgress(100);
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // 3. 피팅 모드 활성화
        setIsFittingMode(true);
        
        // 4. 실시간 프레임 전송 시작
        fittingIntervalRef.current = setInterval(() => {
            sendFittingFrame();
        }, 200);
        
    } catch (error) {
        console.error("[프론트] 가상 피팅 시작 실패:", error);
        alert("가상 피팅 시작에 실패했습니다: " + error.message);
    } finally {
        // 5. 로딩 종료
        setFittingLoading(false);
    }
};
```

### 4단계: sendFittingFrame 수정 (성능 지표 추가)

```javascript
const sendFittingFrame = async () => {
    if (!videoRef.current || !canvasRef.current) return;

    const startTime = Date.now();
    
    try {
        const canvas = canvasRef.current;
        const context = canvas.getContext('2d');
        
        canvas.width = videoRef.current.videoWidth;
        canvas.height = videoRef.current.videoHeight;
        context.drawImage(videoRef.current, 0, 0);
        
        const frameBase64 = canvas.toDataURL('image/jpeg', 0.8);
        
        const response = await fetch('/api/fit/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                frame: frameBase64,
                showSkeleton: showSkeleton,
                useWarp: useWarp
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success && result.frame) {
                setFittingFrame(result.frame);
                
                // 첫 프레임 수신 시 로딩 종료
                if (fittingLoading) {
                    setFittingLoading(false);
                }
                
                // 성능 지표 계산
                const endTime = Date.now();
                const currentLatency = endTime - startTime;
                setLatency(currentLatency);
                
                // FPS 계산
                const timeSinceLastFrame = endTime - lastFrameTimeRef.current;
                const currentFps = Math.round(1000 / timeSinceLastFrame);
                setFps(currentFps);
                lastFrameTimeRef.current = endTime;
            }
        }
        
    } catch (error) {
        console.error('[프론트] 프레임 전송 실패:', error);
    }
};
```

### 5단계: JSX 수정

```javascript
return (
    <Container fluid className="main-container">
        {/* 전체 화면 로딩 오버레이 */}
        <VirtualFittingLoader
            isLoading={fittingLoading}
            stage={fittingStage}
            progress={fittingProgress}
            showSkeleton={showSkeleton}
            useWarp={useWarp}
        />
        
        <Row className="main-row">
            <Col className="video-column">
                {/* 비디오 컨테이너 */}
                <div className="video-container" style={cameraFrame}>
                    {/* 실시간 상태 배지 */}
                    <FittingStatusBadge
                        isActive={isFittingMode && !fittingLoading}
                        isProcessing={fittingLoading}
                        fps={fps}
                        latency={latency}
                    />
                    
                    {/* 비디오 또는 피팅 프레임 */}
                    {isFittingMode && fittingFrame ? (
                        <img
                            src={fittingFrame}
                            alt="Virtual Fitting"
                            className="fitting-frame"
                        />
                    ) : (
                        <video
                            ref={videoRef}
                            className="video-player"
                            autoPlay
                            playsInline
                            muted
                        />
                    )}
                    
                    <canvas ref={canvasRef} style={{ display: "none" }} />
                </div>
                
                {/* 컨트롤 버튼들 */}
                <div className="controls">
                    <Button
                        variant={isFittingMode ? "danger" : "primary"}
                        onClick={handleStartFit}
                        disabled={fittingLoading}
                        size="lg"
                    >
                        {fittingLoading ? (
                            <>
                                <Spinner
                                    animation="border"
                                    size="sm"
                                    className="me-2"
                                />
                                초기화 중...
                            </>
                        ) : (
                            isFittingMode ? "피팅 중지" : "입어보기"
                        )}
                    </Button>
                    
                    {/* 스켈레톤/변형 토글 */}
                    {isFittingMode && (
                        <>
                            <Button
                                variant={showSkeleton ? "success" : "secondary"}
                                onClick={() => setShowSkeleton(!showSkeleton)}
                            >
                                스켈레톤: {showSkeleton ? 'ON' : 'OFF'}
                            </Button>
                            <Button
                                variant={useWarp ? "success" : "secondary"}
                                onClick={() => setUseWarp(!useWarp)}
                            >
                                모드: {useWarp ? '관절' : '단순'}
                            </Button>
                        </>
                    )}
                </div>
            </Col>
        </Row>
    </Container>
);
```

---

## 고급 옵션

### 1. 백엔드 실시간 상태 폴링

```javascript
const checkFittingStatus = async () => {
    try {
        const response = await fetch('/api/fit/status');
        const status = await response.json();
        
        setFittingStage(status.stage);
        setFittingProgress(status.progress);
        
        return status.stage === 'ready';
    } catch (error) {
        console.error("상태 확인 실패:", error);
        return false;
    }
};

const startVirtualFitting = async () => {
    setFittingLoading(true);
    setFittingStage('initializing');
    
    // 500ms마다 상태 폴링
    const pollInterval = setInterval(async () => {
        const isReady = await checkFittingStatus();
        
        if (isReady) {
            clearInterval(pollInterval);
            setFittingLoading(false);
            setIsFittingMode(true);
            
            // 프레임 전송 시작
            fittingIntervalRef.current = setInterval(() => {
                sendFittingFrame();
            }, 200);
        }
    }, 500);
};
```

### 2. 에러 상태 표시

```javascript
const [fittingError, setFittingError] = useState(null);

// VirtualFittingLoader에 에러 표시 추가
{fittingError && (
    <Alert variant="danger" className="mt-3">
        {fittingError}
    </Alert>
)}
```

### 3. 취소 기능

```javascript
const cancelFitting = () => {
    if (pollIntervalRef.current) {
        clearInterval(pollIntervalRef.current);
    }
    setFittingLoading(false);
    setFittingStage('initializing');
    setFittingProgress(0);
};

// VirtualFittingLoader에 취소 버튼 추가
<Button
    variant="outline-light"
    onClick={cancelFitting}
>
    취소
</Button>
```

---

## 시각적 효과 커스터마이징

### 로딩 컬러 테마 변경

```css
/* VirtualFittingLoader.css */
.virtual-fitting-loader-container {
    /* 기본: 보라색 그라디언트 */
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    
    /* 옵션 1: 파란색 */
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    
    /* 옵션 2: 초록색 */
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    
    /* 옵션 3: 주황색 */
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}
```

### 애니메이션 속도 조절

```css
.loader-spinner {
    animation-duration: 1s;  /* 기본: 0.75s */
}

.spinner-glow {
    animation-duration: 3s;  /* 기본: 2s */
}
```

---

## 성능 최적화

### 1. 프레임 전송 간격 조절

```javascript
// 고성능: 100ms (10 FPS)
fittingIntervalRef.current = setInterval(() => {
    sendFittingFrame();
}, 100);

// 균형: 200ms (5 FPS) - 권장
fittingIntervalRef.current = setInterval(() => {
    sendFittingFrame();
}, 200);

// 저성능: 500ms (2 FPS)
fittingIntervalRef.current = setInterval(() => {
    sendFittingFrame();
}, 500);
```

### 2. 이미지 품질 조절

```javascript
// 고품질 (더 느림)
const frameBase64 = canvas.toDataURL('image/jpeg', 1.0);

// 균형 (권장)
const frameBase64 = canvas.toDataURL('image/jpeg', 0.8);

// 저품질 (더 빠름)
const frameBase64 = canvas.toDataURL('image/jpeg', 0.5);
```

---

## 테스트 체크리스트

- [ ] 로딩 오버레이가 표시되는가?
- [ ] 진행률 바가 증가하는가?
- [ ] 체크리스트 항목이 순차적으로 완료되는가?
- [ ] 첫 프레임 수신 시 로딩이 사라지는가?
- [ ] 상태 배지가 올바르게 표시되는가?
- [ ] FPS와 레이턴시가 업데이트되는가?
- [ ] 스켈레톤/변형 토글이 작동하는가?
- [ ] 중지 버튼이 정상 작동하는가?
- [ ] 모바일에서도 잘 보이는가?
- [ ] 에러 발생 시 적절한 메시지가 표시되는가?

---

**작성일**: 2025-10-24  
**관련 파일**: 
- VirtualFittingLoader.js/css
- FittingStatusBadge.js/css
- main.js
