# 🧪 큐 크기 최적화 테스트 가이드

## 📋 개요

**목적**: 큐 크기를 1부터 자동으로 증가시키며 최적값을 찾는 테스트  
**방법**: 각 큐 크기당 2초 동안 테스트, FPS 측정  
**종료 조건**: FPS가 5회 연속 감소하면 테스트 자동 종료  
**테스트 비디오**: `C:\Users\parkj\Desktop\ponggwi\source\basic.mp4`

---

## 🚀 테스트 실행

### 1. 테스트 스크립트 실행
```powershell
cd C:\Users\parkj\Desktop\Smart_Closet\back\fit
python test_queue_size.py
```

### 2. 테스트 진행 과정
```
[테스트] 모델 로딩 중... (device: cuda:0)
[테스트] GPU 워밍업 완료
[테스트] 테스트 설정:
  - 배치 크기: 8
  - 추론 해상도: 65%
  - 테스트 시간: 2초
  - 비디오: C:\Users\parkj\Desktop\ponggwi\source\basic.mp4

======================================================================
[테스트] 큐 크기 1 테스트 시작
======================================================================
[테스트] 비디오 정보: 300 프레임, 30.00 FPS

[테스트] 큐 크기 1 결과:
  - 처리 프레임: 150 / 200 (전송됨)
  - 실제 FPS: 75.00
  - 평균 배치 추론 시간: 26.50ms
  - GPU 메모리: 2.34 GB
  - 테스트 시간: 2.00초

======================================================================
[테스트] 큐 크기 2 테스트 시작
======================================================================
...
```

### 3. 최종 결과 확인
```
======================================================================
[테스트] 최종 결과
======================================================================
큐 크기      | FPS        | 성능 변화      
----------------------------------------
1          | 75.00      | 기준             
2          | 85.50      | +10.50 (+14.0%) 
3          | 92.30      | +6.80 (+8.0%)   
4          | 98.20      | +5.90 (+6.4%)   
5          | 103.45     | +5.25 (+5.3%)   
6          | 107.80     | +4.35 (+4.2%)   
7          | 110.20     | +2.40 (+2.2%)   
8          | 112.50     | +2.30 (+2.1%) ⭐ 최고
9          | 111.80     | -0.70 (-0.6%)   
10         | 110.50     | -1.30 (-1.2%)   
11         | 109.20     | -1.30 (-1.2%)   
12         | 107.80     | -1.40 (-1.3%)   
13         | 106.50     | -1.30 (-1.2%)   

[테스트] ⚠️ FPS가 5회 연속 감소하여 테스트 종료

======================================================================
[테스트] 🏆 최적 큐 크기: 8 (FPS: 112.50)
======================================================================

[테스트] 권장 설정:

# virtual_fitting.py에 적용:
self.inference_queue = queue.Queue(maxsize=8)
self.result_queue = queue.Queue(maxsize=4)
```

---

## 📊 테스트 세부 정보

### 테스트 설정
- **배치 크기**: 8 (고정)
- **추론 해상도**: 65% (고정)
- **테스트 시간**: 각 큐 크기당 2초
- **종료 조건**: FPS 5회 연속 감소

### 측정 항목
- **처리 프레임**: 2초 동안 처리한 프레임 수
- **실제 FPS**: `처리 프레임 / 테스트 시간`
- **평균 배치 추론 시간**: 배치 1개 처리 시간
- **GPU 메모리**: 현재 GPU 메모리 사용량

### 성능 변화 계산
```python
성능 변화 = 현재 FPS - 이전 FPS
변화율 = (성능 변화 / 이전 FPS) × 100%
```

---

## 🔍 결과 해석

### 1. 큐 크기 증가에 따른 FPS 변화

```
큐 크기 1-5: 급격한 FPS 증가 (버퍼링 부족 해소)
  → GPU가 항상 작업 대기 상태 유지
  → 대기 시간 감소

큐 크기 6-8: 완만한 FPS 증가 (최적점 접근)
  → GPU 활용도 최대화
  → 추가 버퍼링 효과 감소

큐 크기 9+: FPS 감소 시작 (오버헤드 증가)
  → 큐 관리 비용 증가
  → 메모리 오버헤드
  → 캐시 효율 저하
```

### 2. 최적 큐 크기 선택 기준

**최고 FPS를 기록한 큐 크기 선택**
- FPS가 최대인 지점
- 추가 증가 시 성능 저하 시작

**예시**:
- 큐 크기 8: 112.50 FPS ⭐ 최고
- 큐 크기 9: 111.80 FPS (감소)
- **→ 최적 큐 크기: 8**

---

## ⚙️ 큐 크기 적용 방법

### virtual_fitting.py 수정

**현재 코드** (Line ~117):
```python
self.inference_queue = queue.Queue(maxsize=20)
self.result_queue = queue.Queue(maxsize=8)
```

**최적화 적용** (테스트 결과가 8이면):
```python
self.inference_queue = queue.Queue(maxsize=8)  # 테스트 결과 적용
self.result_queue = queue.Queue(maxsize=4)     # 추론 큐의 절반
```

---

## 🎯 큐 크기와 성능의 관계

### 큐 크기가 너무 작을 때 (1-3)
**문제**:
- GPU 대기 시간 발생
- 프레임 도착 대기로 인한 유휴 시간
- GPU 활용도 낮음 (40-60%)

**증상**:
- 낮은 FPS
- GPU 사용률 60% 이하
- 프레임 처리 지연

### 큐 크기가 적절할 때 (최적값)
**장점**:
- GPU 항상 작업 대기
- 최대 처리량
- 최소 대기 시간

**특징**:
- 최고 FPS
- GPU 사용률 85%+
- 안정적인 성능

### 큐 크기가 너무 클 때 (최적값 + 5 이상)
**문제**:
- 큐 관리 오버헤드 증가
- 메모리 오버헤드
- 캐시 미스 증가

**증상**:
- FPS 감소
- 메모리 사용량 증가
- 레이턴시 증가

---

## 📈 예상 성능 개선

### 큐 크기 최적화 전후 비교

| 항목 | 큐 크기 20 (현재) | 최적 큐 크기 (예: 8) | 변화 |
|------|-------------------|---------------------|------|
| **FPS** | ~95 FPS | ~112 FPS | +18% |
| **GPU 사용률** | 70% | 85% | +21% |
| **메모리** | 3.2 GB | 2.8 GB | -12% |
| **레이턴시** | 70ms | 55ms | -21% |

---

## ⚠️ 주의사항

### 1. 비디오 파일 확인
```powershell
# 비디오 파일 존재 확인
Test-Path "C:\Users\parkj\Desktop\ponggwi\source\basic.mp4"
```

**파일이 없으면**:
```python
# test_queue_size.py 수정
video_path = r"C:\Users\parkj\Desktop\다른경로\video.mp4"
```

### 2. GPU 메모리 부족 시
```
[ERROR] CUDA out of memory
```

**해결 방법**:
```python
# test_queue_size.py에서 배치 크기 감소
self.batch_size = 5  # 8 → 5
```

### 3. 테스트 시간 조정
```python
# test_queue_size.py 수정
self.test_duration = 3.0  # 2초 → 3초 (더 정확한 측정)
```

### 4. 최대 큐 크기 조정
```python
# test_queue_size.py 수정
max_queue_size = 50  # 100 → 50 (빠른 테스트)
```

---

## 🔧 고급 설정

### 1. 다양한 비디오로 테스트
```python
# test_queue_size.py의 main() 함수 수정
video_paths = [
    r"C:\Users\parkj\Desktop\ponggwi\source\basic.mp4",
    r"C:\Users\parkj\Desktop\ponggwi\source\test1.mp4",
    r"C:\Users\parkj\Desktop\ponggwi\source\test2.mp4"
]

for video_path in video_paths:
    print(f"\n[테스트] 비디오: {video_path}")
    tester = QueueSizeTester(video_path)
    tester.run_optimization_test()
```

### 2. 다양한 배치 크기 테스트
```python
# test_queue_size.py 수정
for batch_size in [5, 8, 10]:
    print(f"\n[테스트] 배치 크기: {batch_size}")
    tester = QueueSizeTester(video_path)
    tester.batch_size = batch_size
    tester.run_optimization_test()
```

### 3. CSV 결과 저장
```python
# test_queue_size.py에 추가
import csv

# run_optimization_test() 함수 마지막에 추가
with open('queue_size_test_results.csv', 'w', newline='') as f:
    writer = csv.writer(f)
    writer.writerow(['Queue Size', 'FPS', 'Change'])
    
    for i, (queue_size, fps) in enumerate(results):
        if i == 0:
            change = 0
        else:
            change = fps - results[i-1][1]
        writer.writerow([queue_size, fps, change])

print("[테스트] 결과를 queue_size_test_results.csv에 저장했습니다.")
```

---

## 📚 관련 문서

- [GPU 사용량 최적화 완료](./GPU_사용량_최적화_완료.md)
- [백그라운드 실행 스트리밍 제어 완료](./백그라운드_실행_스트리밍_제어_완료.md)
- [추론 최적화 완료](./추론_최적화_완료.md)

---

**작성 일시**: 2025-01-XX  
**작성자**: GitHub Copilot  
**버전**: 1.0
